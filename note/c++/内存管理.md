# 内存管理

### 内存空间

内存空间包含：内核空间、栈、堆、数据段、代码段。地址从高到低。如下图：

![men](/note/c++/men.png)

**内核空间**是操作系统内核所占用的空间，这部分空间是受保护的，不能被用户直接访问。

**栈**是函数调用时使用的空间，每个函数调用都会创建一个栈帧，用于存储函数的**局部变量**、**函数参数**和**函数返回值**。栈空间是自动分配和释放的，栈空间的大小是固定的，可以通过设置栈的大小来控制函数调用的深度。

**堆**是用于动态分配内存的空间，程序可以通过调用malloc、new等函数来在堆上分配内存。堆空间的大小是不固定的，可以通过设置堆的大小来控制内存的使用。

**数据段**是用于存储程序中定义的**静态变量**、**全局变量**等。数据段的空间是固定的，程序运行时会分配相应的空间。

**代码段**是用于存储程序的代码。代码段的空间是固定的，程序运行时会分配相应的空间。

### 栈与堆的区别

1、管理方式不同，栈会自动释放空间，而堆需要手动释放空间。

2、空间大小不同，堆的受限于物理内存空间，栈会更小一点。

3、分配方式不同，栈是静态分配，而堆是动态分配。

4、分配效率不同，栈由操作系统支持，效率会更高。

5、堆由于频繁分配和释放，会导致内存空间不连续，容易产生内存碎片，会导致性能下降。栈是按照进出栈的顺序存放的，因此不会产生碎片。

6、栈向下增长，堆向上增长。

## 堆区内存使用

1、申请内存。`int* p = new int(5);` c++通过new关键字动态分配内存，在面向对象编程时常用。在c中可以通过`malloc`函数动态分配内存。

2、使用内存。`*p = 8;` 内存的操作和使用只能通过指针实行。 

3、释放内存。c++通过`delet p;`。c通过free关键字释放内存。如果不释放会导致内存泄漏。 

**内存泄漏**是指程序中不再使用的内存没有及时释放，导致内存占用越来越多，最终导致内存溢出。

**内存溢出**是指程序中使用的内存超过了系统分配的内存，导致程序无法继续运行。

*注意*：动态内存不与变量绑定。因此，动态内存的生命周期和整个程序相同，即使操作该内存的指针在某作用域失效申请的动态内存依然存在。当程序结束时，系统将自动回未释放的内存。